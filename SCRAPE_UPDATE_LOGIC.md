# çˆ¬å–æ›´æ–°é€»è¾‘è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æ¯10åˆ†é’Ÿçˆ¬å– DexScreener æ¶¨å¹…æ¦œï¼Œå¯¹äºå·²å­˜åœ¨çš„ä»£å¸ï¼Œæ™ºèƒ½æ›´æ–°æ•°æ®åº“å­—æ®µï¼Œåªä¿ç•™æœ€é«˜æ¶¨å¹…è®°å½•ã€‚

## æ›´æ–°ç­–ç•¥

### æƒ…å†µ1: ä»£å¸ä¸å­˜åœ¨
- **æ“ä½œ**: åˆ›å»ºæ–°è®°å½•
- **ä¿å­˜å­—æ®µ**:
  - `scraped_price_usd`: çˆ¬å–æ—¶ä»·æ ¼
  - `price_change_24h_at_scrape`: 24hæ¶¨å¹…
  - `market_cap_at_scrape`: å¸‚å€¼
  - `liquidity_at_scrape`: æµåŠ¨æ€§
  - `volume_24h_at_scrape`: 24häº¤æ˜“é‡
  - `scraped_timestamp`: çˆ¬å–æ—¶é—´

### æƒ…å†µ2: ä»£å¸å·²å­˜åœ¨ + æ–°æ¶¨å¹… > åŸæ¶¨å¹…
- **æ“ä½œ**: æ›´æ–°æ‰€æœ‰çˆ¬å–å­—æ®µ
- **æ›´æ–°å­—æ®µ**: æ‰€æœ‰ `*_at_scrape` å­—æ®µ
- **æ—¥å¿—**: `ğŸ”„ Updated {symbol}: æ¶¨å¹…ä» X% â†’ Y%`

### æƒ…å†µ3: ä»£å¸å·²å­˜åœ¨ + æ–°æ¶¨å¹… <= åŸæ¶¨å¹…
- **æ“ä½œ**: è·³è¿‡æ›´æ–°ï¼Œä¿ç•™åŸè®°å½•
- **åŸå› **: ä¿æŒæœ€é«˜æ¶¨å¹…è®°å½•ï¼Œè¿½è¸ªä»£å¸çš„å†å²æœ€é«˜è¡¨ç°
- **æ—¥å¿—**: `â­ï¸  {symbol} æ¶¨å¹…æœªæé«˜ (å½“å‰: X%, æœ€é«˜: Y%)`

## ä»£ç å®ç°

### æ ¸å¿ƒé€»è¾‘ ([token_monitor_service.py](src/services/token_monitor_service.py#L859-L885))

```python
# æ£€æŸ¥ä»£å¸æ˜¯å¦å·²å­˜åœ¨
existing = await session.execute(
    select(PotentialToken).where(
        PotentialToken.pair_address == pair_address
    )
).scalar_one_or_none()

if existing:
    old_change = existing.price_change_24h_at_scrape or 0

    # æ¶¨å¹…æ¯”è¾ƒ
    if price_change_24h > old_change:
        # æ›´æ–°æ‰€æœ‰å­—æ®µ
        existing.scraped_price_usd = price_usd
        existing.scraped_timestamp = datetime.utcnow()
        existing.market_cap_at_scrape = market_cap
        existing.liquidity_at_scrape = liquidity_usd
        existing.volume_24h_at_scrape = volume_24h
        existing.price_change_24h_at_scrape = price_change_24h

        logger.info(f"ğŸ”„ Updated {symbol}: {old_change}% â†’ {price_change_24h}%")
    else:
        # è·³è¿‡æ›´æ–°
        logger.info(f"â­ï¸  {symbol} æ¶¨å¹…æœªæé«˜")
else:
    # åˆ›å»ºæ–°è®°å½•
    potential_token = PotentialToken(...)
    session.add(potential_token)
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬: [test_scrape_update.py](test_scrape_update.py)

```bash
python3 test_scrape_update.py
```

### æµ‹è¯•ç»“æœ

```
ã€æ­¥éª¤2ã€‘æ¨¡æ‹Ÿçˆ¬å–æ›´é«˜æ¶¨å¹…æ•°æ®
  æ•°æ®åº“æ¶¨å¹…: 50.00%
  çˆ¬å–æ¶¨å¹…: 100.0%
  âœ… æ¶¨å¹…æ›´é«˜ï¼Œå·²æ›´æ–°: 50.00% â†’ 100.0%

ã€æ­¥éª¤4ã€‘æ¨¡æ‹Ÿçˆ¬å–æ›´ä½æ¶¨å¹…æ•°æ®
  æ•°æ®åº“æ¶¨å¹…: 100.00%
  çˆ¬å–æ¶¨å¹…: 80.0%
  â­ï¸  æ¶¨å¹…æœªæé«˜ï¼ˆ80.0% <= 100.00%ï¼‰ï¼Œè·³è¿‡æ›´æ–°
```

## ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: ä»£å¸æŒç»­ä¸Šæ¶¨

```
æ—¶é—´      çˆ¬å–æ¶¨å¹…    æ•°æ®åº“æ¶¨å¹…    æ“ä½œ
10:00     100%        -           åˆ›å»ºè®°å½• (100%)
10:10     150%        100%        æ›´æ–° â†’ 150%
10:20     200%        150%        æ›´æ–° â†’ 200%
10:30     180%        200%        è·³è¿‡ï¼ˆæœªè¶…è¿‡200%ï¼‰
10:40     250%        200%        æ›´æ–° â†’ 250%
```

**ç»“æœ**: æ•°æ®åº“å§‹ç»ˆä¿å­˜æœ€é«˜æ¶¨å¹… 250%

### åœºæ™¯2: ä»£å¸æ¶¨å¹…å›è½

```
æ—¶é—´      çˆ¬å–æ¶¨å¹…    æ•°æ®åº“æ¶¨å¹…    æ“ä½œ
10:00     500%        -           åˆ›å»ºè®°å½• (500%)
10:10     300%        500%        è·³è¿‡ï¼ˆæœªè¶…è¿‡500%ï¼‰
10:20     200%        500%        è·³è¿‡ï¼ˆæœªè¶…è¿‡500%ï¼‰
10:30     150%        500%        è·³è¿‡ï¼ˆæœªè¶…è¿‡500%ï¼‰
```

**ç»“æœ**: æ•°æ®åº“ä¿ç•™å³°å€¼æ¶¨å¹… 500%ï¼Œè¿½è¸ªå†å²æœ€ä½³è¡¨ç°

## ä¼˜åŠ¿

1. **è¿½è¸ªå†å²æœ€é«˜è¡¨ç°**: ä¿ç•™ä»£å¸çš„å³°å€¼æ¶¨å¹…æ•°æ®
2. **å‡å°‘æ— æ•ˆæ›´æ–°**: æ¶¨å¹…å›è½æ—¶ä¸æ›´æ–°ï¼ŒèŠ‚çœæ•°æ®åº“å†™å…¥
3. **å®Œæ•´è®°å½•**: æ¯æ¬¡æ¶¨å¹…çªç ´éƒ½ä¼šæ›´æ–°æ‰€æœ‰ç›¸å…³å­—æ®µ
4. **å¯è¿½æº¯**: `scraped_timestamp` è®°å½•æœ€é«˜æ¶¨å¹…çš„æ—¶é—´

## å®šæ—¶ä»»åŠ¡é…ç½®

### Scheduler Daemon ([scheduler_daemon.py](scheduler_daemon.py))

```python
# æ¯10åˆ†é’Ÿçˆ¬å–ä¸€æ¬¡
scheduler.add_job(
    scrape_dexscreener_task,
    trigger=IntervalTrigger(minutes=10),
    id='scrape_dexscreener',
    name='çˆ¬å–DexScreeneré¦–é¡µ',
    max_instances=1,
    coalesce=True
)
```

### ä»»åŠ¡å‡½æ•°

```python
async def scrape_dexscreener_task():
    result = await monitor_service.scrape_and_save_to_potential(
        count=100,      # çˆ¬å–100ä¸ªä»£å¸
        top_n=10,       # å–å‰10åæ¶¨å¹…æ¦œ
        headless=True   # æ— å¤´æ¨¡å¼
    )

    logger.info(
        f"çˆ¬å–å®Œæˆï¼šå…±çˆ¬å– {result['scraped']} ä¸ªä»£å¸ï¼Œ"
        f"ä¿å­˜ {result['saved']} ä¸ªåˆ°æ•°æ®åº“"
    )
```

## æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®šæ—¶ä»»åŠ¡: æ¯10åˆ†é’Ÿçˆ¬å– DexScreener                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        çˆ¬å– BSC é“¾æ¶¨å¹…æ¦œ Top 10
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               â”‚
ä»£å¸ä¸å­˜åœ¨                      ä»£å¸å·²å­˜åœ¨
    â”‚                               â”‚
åˆ›å»ºæ–°è®°å½•                   æ¯”è¾ƒæ¶¨å¹…
(æ¶¨å¹… X%)                        â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚                   â”‚
    â”‚             æ–°æ¶¨å¹… > åŸæ¶¨å¹…      æ–°æ¶¨å¹… <= åŸæ¶¨å¹…
    â”‚                    â”‚                   â”‚
    â”‚              æ›´æ–°æ‰€æœ‰å­—æ®µ           è·³è¿‡æ›´æ–°
    â”‚              (æ¶¨å¹… Y%)            (ä¿ç•™åŸæ¶¨å¹… Z%)
    â”‚                    â”‚                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
          potential_tokens è¡¨
       ï¼ˆä¿å­˜å†å²æœ€é«˜æ¶¨å¹…è®°å½•ï¼‰
```

## API æ¥å£

### è·å–æ½œåŠ›ä»£å¸åˆ—è¡¨

```bash
GET /api/potential-tokens?limit=100

# å“åº”ç¤ºä¾‹
{
  "total": 9,
  "data": [
    {
      "token_symbol": "æ¯”å¿ƒ",
      "scraped_price_usd": 0.001318,
      "price_change_24h_at_scrape": 975.0,  // å†å²æœ€é«˜æ¶¨å¹…
      "scraped_timestamp": "2025-10-23T01:38:03",
      "market_cap_at_scrape": 5000000.0,
      "is_added_to_monitoring": 0
    }
  ]
}
```

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ç¤ºä¾‹

```
[INFO] ã€çˆ¬å–æ½œåŠ›å¸ç§ã€‘ä¿å­˜åˆ° potential_tokens è¡¨
[INFO] âœ… Added NEWTOKEN to potential_tokens (+500.0%)
[INFO] ğŸ”„ Updated æ¯”å¿ƒ: æ¶¨å¹…ä» 900.0% â†’ 975.0% (+75.0%)
[INFO] â­ï¸  GENESIS æ¶¨å¹…æœªæé«˜ (å½“å‰: 800.0%, æœ€é«˜: 837.0%)
[INFO] âœ… Saved to potential_tokens: 8 added/updated, 2 skipped
```

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡æ—¥å¿—

```bash
tail -f /tmp/blockchain-scheduler.log
```

## æ³¨æ„äº‹é¡¹

1. **æ¶¨å¹…åŸºå‡†**: ä»¥ DexScreener çš„ 24h æ¶¨å¹…ä¸ºå‡†
2. **å”¯ä¸€æ ‡è¯†**: ä½¿ç”¨ `pair_address` ä½œä¸ºå”¯ä¸€æ ‡è¯†
3. **æ—¶é—´æˆ³**: `scraped_timestamp` è®°å½•æœ€åä¸€æ¬¡æ¶¨å¹…çªç ´çš„æ—¶é—´
4. **æ•°æ®ä¸€è‡´æ€§**: æ›´æ–°æ—¶æ‰€æœ‰ `*_at_scrape` å­—æ®µåŒæ­¥æ›´æ–°

## ç›¸å…³æ–‡ä»¶

- æ ¸å¿ƒé€»è¾‘: [src/services/token_monitor_service.py#L790-L922](src/services/token_monitor_service.py#L790-L922)
- å®šæ—¶ä»»åŠ¡: [scheduler_daemon.py](scheduler_daemon.py)
- æµ‹è¯•è„šæœ¬: [test_scrape_update.py](test_scrape_update.py)
- æ•°æ®æ¨¡å‹: [src/storage/models.py](src/storage/models.py)
